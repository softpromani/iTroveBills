name: Deploy to Hostinger

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # ðŸ”¹ Setup PHP & Composer (Required for Ziggy)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, mysql, bcmath
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      # ðŸ”¹ Build frontend (Vite)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies & build
        run: |
          npm ci
          npm run build

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # ðŸ”¹ Upload only Vite build folder
      - name: Upload built assets (Vite)
        run: |
          rsync -avz public/build/ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.PROJECT_PATH }}/public/build/

      - name: Deploy via SSH
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            echo "ðŸ›  Putting app in maintenance mode..."
            php artisan down || true

            echo "ðŸ”„ Pulling latest changes..."
            git pull origin master

            echo "ðŸ“¦ Checking if composer install is needed..."
            CHANGED=false
            if [ ! -d "vendor" ]; then
              CHANGED=true
            elif [ composer.lock -nt vendor ]; then
              CHANGED=true
            fi

            if [ "$CHANGED" = true ]; then
              echo "ðŸ“¦ Installing composer dependencies..."
              composer2 install --no-interaction --prefer-dist --optimize-autoloader
            else
              echo "âœ… Skipping composer install - no changes."
            fi

            echo "ðŸ—„ Checking if migrations are pending..."
            OUTDATED=$(php artisan migrate:status | grep 'No' | wc -l)
            if [ "$OUTDATED" -gt 0 ]; then
              echo "ðŸ—„ Running pending migrations..."
              php artisan migrate --force --verbose
            else
              echo "âœ… No migrations needed."
            fi

            echo "ðŸ§¹ Clearing caches..."
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear

            echo "ðŸš€ Optimizing application..."

            echo "ðŸ”“ Bringing app back online..."
            php artisan up

            echo "âœ… Deployment completed!"
          EOF
